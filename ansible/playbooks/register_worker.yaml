---
- name: ðŸ¤– Register Jenkins Workers on Master
  hosts: jenkins_master
  become: yes
  vars:
    jenkins_url: "http://localhost:8080"
    jenkins_user: "admin"
    jenkins_password: "{{ lookup('file', '/var/lib/jenkins/secrets/initialAdminPassword') | default('admin', true) }}"
    worker_labels: "linux,build"
    worker_executor_count: 2

  tasks:
    - name: Wait for Jenkins API to become ready
      uri:
        url: "{{ jenkins_url }}/login"
        status_code: 200
      register: jenkins_api_ready
      retries: 15
      delay: 10
      until: jenkins_api_ready.status == 200

    - name: Register each Jenkins worker node via REST API
      uri:
        url: "{{ jenkins_url }}/computer/doCreateItem?name={{ item }}"
        method: POST
        user: "{{ jenkins_user }}"
        password: "{{ jenkins_password }}"
        force_basic_auth: yes
        status_code: 200,302
        headers:
          Content-Type: "application/x-www-form-urlencoded"
        body: "type=hudson.slaves.DumbSlave&json={
          \"name\": \"{{ item }}\",
          \"nodeDescription\": \"Auto-registered worker\",
          \"numExecutors\": {{ worker_executor_count }},
          \"remoteFS\": \"/opt/jenkins\",
          \"labelString\": \"{{ worker_labels }}\",
          \"mode\": \"NORMAL\",
          \"launcher\": {
            \"stapler-class\": \"hudson.slaves.JNLPLauncher\",
            \"workDirSettings\": {
              \"disabled\": false,
              \"internalDir\": \"remoting\",
              \"workDirPath\": \"\"
            }
          }
        }"
      loop: "{{ groups['jenkins_worker'] }}"
      register: registration_results
      ignore_errors: yes

    - name: Show registration summary
      debug:
        msg: "ðŸ§© Jenkins Worker '{{ item.item }}' registration status: {{ item.status }}"
      loop: "{{ registration_results.results }}"
