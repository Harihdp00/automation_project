---
- name: Verify Jenkins Master and Worker Status
  hosts: jenkins_master
  become: yes
  vars:
    jenkins_url: "http://localhost:8080"
    jenkins_user: "admin"
    jenkins_password_file: "/var/lib/jenkins/secrets/initialAdminPassword"

  tasks:
    - name: Wait for Jenkins to be accessible
      wait_for:
        host: 127.0.0.1
        port: 8080
        state: started
        delay: 10
        timeout: 300

    - name: Read Jenkins admin password
      slurp:
        src: "{{ jenkins_password_file }}"
      register: admin_pass_raw

    - name: Decode Jenkins admin password
      set_fact:
        jenkins_password: "{{ admin_pass_raw.content | b64decode | trim }}"

    - name: Check Jenkins login page
      uri:
        url: "{{ jenkins_url }}/login"
        return_content: yes
        status_code: 200
      register: login_check

    - name: Display Jenkins Master reachability
      debug:
        msg: >
          âœ… Jenkins is accessible at {{ jenkins_url }} (HTTP {{ login_check.status }})

    - name: Get list of all nodes via Jenkins API
      uri:
        url: "{{ jenkins_url }}/computer/api/json"
        user: "{{ jenkins_user }}"
        password: "{{ jenkins_password }}"
        force_basic_auth: yes
        return_content: yes
      register: nodes_info

    - name: Display registered Jenkins nodes
      debug:
        msg: >
          ğŸ–¥ï¸ Registered Jenkins nodes: {{
            nodes_info.json.computer | map(attribute='displayName') | join(', ')
          }}

    - name: Verify that all expected worker nodes are registered
      assert:
        that:
          - groups['jenkins_workers'] | difference(
              nodes_info.json.computer | map(attribute='displayName') | list
            ) | length == 0
        fail_msg: "âŒ Some worker nodes are missing in Jenkins!"
        success_msg: "âœ… All Jenkins worker nodes successfully registered."
