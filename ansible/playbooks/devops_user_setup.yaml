---
- name: Ensure common DevOps user is configured
  hosts: all
  become: yes

  tasks:
    - name: Create devops user
      user:
        name: devops
        state: present
        shell: /bin/bash
        create_home: yes

    - name: Add devops user to sudoers with no password
      copy:
        dest: /etc/sudoers.d/devops
        content: "devops ALL=(ALL) NOPASSWD:ALL\n"
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'

    - name: Ensure .ssh directory exists with correct ownership
      file:
        path: /home/devops/.ssh
        state: directory
        owner: devops
        group: devops
        mode: '0700'

    - name: Copy authorized key from control node
      authorized_key:
        user: devops
        state: present
        key: "{{ lookup('file', 'files/authorized_keys') }}"
