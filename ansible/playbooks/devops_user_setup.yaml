---
- name: Ensure common DevOps user is configured
  hosts: all
  become: yes
  tasks:
    - name: Create devops user if not exists
      user:
        name: devops
        state: present
        shell: /bin/bash
        create_home: yes

    - name: Add devops user to sudoers with no password
      copy:
        dest: /etc/sudoers.d/devops
        content: "devops ALL=(ALL) NOPASSWD:ALL\n"
        mode: '0440'

    - name: Ensure .ssh directory exists
      file:
        path: /home/devops/.ssh
        state: directory
        owner: devops
        group: devops
        mode: '0700'

    - name: Copy authorized_keys from control node
      authorized_key:
        user: devops
        state: present
        key: "{{ lookup('file', '/home/devops/.ssh/authorized_keys') }}"

    - name: Set correct ownership for .ssh directory
      file:
        path: /home/devops/.ssh
        owner: devops
        group: devops
        recurse: yes
